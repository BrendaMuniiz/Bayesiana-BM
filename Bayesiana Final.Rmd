---
title: "Bayesiana Trab 2"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

```{r}

library(tidyverse)    # ggplot, dplyr, %>%, and friends
library(gapminder)    # Country-year panel data from the Gapminder Project
library(brms)         # Bayesian modeling through Stan
library(tidybayes)    # Manipulate Stan objects in a tidy way
library(broom)        # Convert model objects to data frames
library(broom.mixed)  # Convert brms model objects to data frames
library(emmeans)      # Calculate marginal effects in even fancier ways
library(ggh4x)        # For nested facets in ggplot
library(ggrepel)      # For nice non-overlapping labels in ggplot
library(ggdist)       # For distribution-related ggplot geoms
library(scales)       # For formatting numbers with comma(), dollar(), etc.
library(patchwork)    # For combining plots
library(ggokabeito)   # Colorblind-friendly color palette

# Make all the random draws reproducible
set.seed(1234)

# Bayes stuff
# Use the cmdstanr backend for Stan because it's faster and more modern than
# the default rstan. You need to install the cmdstanr package first
# (https://mc-stan.org/cmdstanr/) and then run cmdstanr::install_cmdstan() to
# install cmdstan on your computer.
options(mc.cores = 4,  # Use 4 cores
        brms.backend = "cmdstanr")
bayes_seed <- 1234

# Custom ggplot theme to make pretty plots
# Get Barlow Semi Condensed at https://fonts.google.com/specimen/Barlow+Semi+Condensed
theme_clean <- function() {
  theme_minimal(base_family = "Barlow Semi Condensed") +
    theme(panel.grid.minor = element_blank(),
          plot.background = element_rect(fill = "white", color = NA),
          plot.title = element_text(face = "bold"),
          axis.title = element_text(face = "bold"),
          strip.text = element_text(face = "bold", size = rel(0.8), hjust = 0),
          strip.background = element_rect(fill = "grey80", color = NA),
          legend.title = element_text(face = "bold"))
}

# Make labels use Barlow by default
update_geom_defaults("label_repel", 
                     list(family = "Barlow Semi Condensed",
                          fontface = "bold"))
update_geom_defaults("label", 
                     list(family = "Barlow Semi Condensed",
                          fontface = "bold"))

# The ggh4x paackage includes a `facet_nested()` function for nesting facets
# (like countries in continents). Throughout this post, I want the
# continent-level facets to use bolder text and a lighter gray strip. I don't
# want to keep repeating all these settings, though, so I create a list of the
# settings here with `strip_nested()` and feed it to `facet_nested_wrap()` later
nested_settings <- strip_nested(
  text_x = list(element_text(family = "Barlow Semi Condensed Black", 
                             face = "plain"), NULL),
  background_x = list(element_rect(fill = "grey92"), NULL),
  by_layer_x = TRUE)
```

```{r}
# Little dataset of 8 countries (2 for each of the 4 continents in the data)
# that are good examples of different trends and intercepts
countries <- tribble(
  ~country,       ~continent,
  "Egypt",        "Africa",
  "Sierra Leone", "Africa",
  "Pakistan",     "Asia",
  "Yemen, Rep.",  "Asia",
  "Bolivia",      "Americas",
  "Canada",       "Americas",
  "Italy",        "Europe",
  "Portugal",     "Europe"
)

# Clean up the gapminder data a little
gapminder <- gapminder::gapminder %>%
  # Remove Oceania since there are only two countries there and we want bigger
  # continent clusters
  filter(continent != "Oceania") %>%
  # Scale down GDP per capita so it's more interpretable ("a $1,000 increase in
  # GDP" vs. "a $1 increase in GDP")
  # Also log it
  mutate(gdpPercap_1000 = gdpPercap / 1000,
         gdpPercap_log = log(gdpPercap)) %>% 
  mutate(across(starts_with("gdp"), list("z" = ~scale(.)))) %>% 
  # Make year centered on 1952 (so we're counting the years since 1952). This
  # (1) helps with interpretability, since the intercept will show the average
  # at 1952 instead of the average at 0 CE, and (2) helps with estimation speed
  # since brms/Stan likes to work with small numbers
  mutate(year_orig = year,
         year = year - 1952) %>% 
  # Indicator for the 8 countries we're focusing on
  mutate(highlight = country %in% countries$country)

# Extract rows for the example countries
original_points <- gapminder %>% 
  filter(country %in% countries$country) %>% 
  # Use real years
  mutate(year = year_orig)
```

```{r}
glimpse(gapminder)
```
The effect of wealth on health, accounting for country and time
```{r}
ggplot(gapminder, aes(x = gdpPercap, y = lifeExp, color = continent)) + 
  geom_point(size = 0.5, alpha = 0.25) +
  geom_smooth(method = "lm", aes(color = NULL), color = "grey60", size = 0.5, 
              se = FALSE, show.legend = FALSE) +
  annotate(geom = "label", label = "Global trend", x = 64000, y = 84, 
           size = 3, color = "grey60") +
  geom_path(aes(group = country, size = highlight),
            arrow = arrow(type = "open", angle = 30, length = unit(0.75, "lines")),
            show.legend = FALSE) +
  geom_label_repel(data = filter(gapminder, year == 15, highlight == TRUE), 
                   aes(label = country), size = 3, seed = 1234, 
                   show.legend = FALSE,
                   family = "Barlow Semi Condensed", fontface = "bold") +
  scale_size_manual(values = c(0.075, 1), guide = "none") +
  scale_color_okabe_ito(order = c(2, 3, 6, 1),
                        guide = guide_legend(override.aes = list(size = 3, alpha = 1))) +
  scale_x_log10(labels = dollar_format(accuracy = 1), breaks = 125 * (2^(1:10))) +
  labs(x = "GDP per capita (log)", y = "Life expectancy", color = "Continent") +
  theme_clean() +
  theme(legend.position = "bottom")
```

```{r}
gdp_mean_sd <- attributes(gapminder$gdpPercap_z)
gdp_mean <- gdp_mean_sd$`scaled:center`
gdp_sd <- gdp_mean_sd$`scaled:scale`

gdp_log_mean_sd <- attributes(gapminder$gdpPercap_log_z)
gdp_log_mean <- gdp_log_mean_sd$`scaled:center`
gdp_log_sd <- gdp_log_mean_sd$`scaled:scale`
```

Regular regression
```{r}
model_gdp_boring <- brm(
  bf(lifeExp ~ gdpPercap_z + year),
  data = gapminder,
  chains = 4, seed = bayes_seed
)
## Start sampling

model_gdp_boring_log <- brm(
  bf(lifeExp ~ gdpPercap_log_z + year),
  data = gapminder,
  chains = 4, seed = bayes_seed
)
## Start sampling
```

```{r}
tidy(model_gdp_boring)
## # A tibble: 4 × 8
##   effect   component group    term            estimate std.error conf.low conf.high
##   <chr>    <chr>     <chr>    <chr>              <dbl>     <dbl>    <dbl>     <dbl>
## 1 fixed    cond      <NA>     (Intercept)       52.6      0.458    51.6      53.4  
## 2 fixed    cond      <NA>     gdpPercap_z        6.47     0.246     5.98      6.95 
## 3 fixed    cond      <NA>     year               0.244    0.0141    0.216     0.272
## 4 ran_pars cond      Residual sd__Observation    9.71     0.170     9.39     10.1
tidy(model_gdp_boring_log)
## # A tibble: 4 × 8
##   effect   component group    term            estimate std.error conf.low conf.high
##   <chr>    <chr>     <chr>    <chr>              <dbl>     <dbl>    <dbl>     <dbl>
## 1 fixed    cond      <NA>     (Intercept)       53.8     0.320     53.2      54.4  
## 2 fixed    cond      <NA>     gdpPercap_log_z    9.55    0.172      9.20      9.88 
## 3 fixed    cond      <NA>     year               0.198   0.00989    0.179     0.217
## 4 ran_pars cond      Residual sd__Observation    6.92    0.120      6.68      7.16
```

```{r}
tidy(model_gdp_boring) %>% 
  mutate(across(c(estimate, std.error, conf.low, conf.high),
                ~ifelse(term == "gdpPercap_z", (. / gdp_sd) * 1000, .)))
## # A tibble: 4 × 8
##   effect   component group    term            estimate std.error conf.low conf.high
##   <chr>    <chr>     <chr>    <chr>              <dbl>     <dbl>    <dbl>     <dbl>
## 1 fixed    cond      <NA>     (Intercept)       52.6      0.458    51.6      53.4  
## 2 fixed    cond      <NA>     gdpPercap_z        0.660    0.0251    0.610     0.709
## 3 fixed    cond      <NA>     year               0.244    0.0141    0.216     0.272
## 4 ran_pars cond      Residual sd__Observation    9.71     0.170     9.39     10.1

tidy(model_gdp_boring_log) %>% 
  mutate(across(c(estimate, std.error, conf.low, conf.high),
                ~ifelse(term == "gdpPercap_log_z", (. / gdp_log_sd), .)))
## # A tibble: 4 × 8
##   effect   component group    term            estimate std.error conf.low conf.high
##   <chr>    <chr>     <chr>    <chr>              <dbl>     <dbl>    <dbl>     <dbl>
## 1 fixed    cond      <NA>     (Intercept)       53.8     0.320     53.2      54.4  
## 2 fixed    cond      <NA>     gdpPercap_log_z    7.74    0.139      7.45      8.01 
## 3 fixed    cond      <NA>     year               0.198   0.00989    0.179     0.217
## 4 ran_pars cond      Residual sd__Observation    6.92    0.120      6.68      7.16
```

```{r}
ame_model_gdp_boring <- model_gdp_boring %>% 
  emtrends(~ 1,
           var = "gdpPercap_z",
           at = list(year = 0),
           epred = TRUE, re_formula = NULL)

pred_ame_model_gdp_boring <- ame_model_gdp_boring %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = .value / gdp_sd * 1000) %>% 
  mutate(fake_facet_title = "GDP per capita")

plot_ame_gdp <- ggplot(pred_ame_model_gdp_boring, aes(x = .value)) +
  stat_halfeye(fill = palette_okabe_ito(5),
               .width = c(0.8, 0.95)) +
  labs(x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a $1,000 increase in GDP per capita"), 
       y = "Density") +
  facet_wrap(vars(fake_facet_title)) +
  theme_clean() +
  theme(strip.text = element_text(size = rel(1.1)))


ame_model_gdp_boring_log <- model_gdp_boring_log %>% 
  emtrends(~ 1,
           var = "gdpPercap_log_z",
           at = list(year = 0),
           epred = TRUE, re_formula = NULL)

pred_ame_model_gdp_boring_log <- ame_model_gdp_boring_log %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = .value / gdp_log_sd / 10) %>% 
  mutate(fake_facet_title = "Logged GDP per capita")

plot_ame_gdp_log <- ggplot(pred_ame_model_gdp_boring_log, aes(x = .value)) +
  stat_halfeye(fill = palette_okabe_ito(5),
               .width = c(0.8, 0.95)) +
  labs(x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a 10% increase in GDP per capita"), 
       y = "Density") +
  facet_wrap(vars(fake_facet_title)) +
  theme_clean() +
  theme(strip.text = element_text(size = rel(1.1)))

(plot_ame_gdp + plot_ame_gdp_log) +
  plot_annotation(title = paste0("Average marginal effect of GDP per capita", "\n",
                                 "(includes year trend with no country-based variation)"), 
                  subtitle = "lifeExp ~ gdpPercap_log_z + year",
                  caption = "80% and 95% credible intervals shown with error bar",
                  theme = theme_clean() + theme(plot.subtitle = element_text(family = "Consolas")))
```

Each country gets its own intercept and GDP slope
```{r}
model_gdp_country_only <- brm(
  bf(lifeExp ~ gdpPercap_z + year + (1 + gdpPercap_z | country),
     decomp = "QR"),
  data = gapminder,
  chains = 4, seed = bayes_seed,
  threads = threading(2)  # Two CPUs per chain to speed things up
)
## Start sampling

model_gdp_country_only_log <- brm(
  bf(lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_log_z | country),
     decomp = "QR"),
  data = gapminder,
  chains = 4, seed = bayes_seed,
  threads = threading(2)  # Two CPUs per chain to speed things up
)
## Start sampling
```

```{r}
# Model with regular GDP per capita
rstan::get_elapsed_time(model_gdp_country_only$fit) %>% 
  as_tibble(rownames = "chain") %>% mutate(total_seconds = warmup + sample)
## # A tibble: 4 × 4
##   chain   warmup sample total_seconds
##   <chr>    <dbl>  <dbl>         <dbl>
## 1 chain:1   22.6   21.4          44.0
## 2 chain:2   25.6   21.1          46.7
## 3 chain:3   24.6   21.4          46.0
## 4 chain:4   23.7   21.3          44.9

# Model with logged GDP per capita 
rstan::get_elapsed_time(model_gdp_country_only_log$fit) %>% 
  as_tibble(rownames = "chain") %>% mutate(total_seconds = warmup + sample)
## # A tibble: 4 × 4
##   chain   warmup sample total_seconds
##   <chr>    <dbl>  <dbl>         <dbl>
## 1 chain:1   12.2   11.1          23.2
## 2 chain:2   12.0   10.9          22.9
## 3 chain:3   11.7   11.0          22.8
## 4 chain:4   12.3   11.0          23.3
```

###Fixed (population-level) effects
```{r}
# Unscale both the GDP coefficient and the GDP random variance coefficient
tidy(model_gdp_country_only) %>% 
  mutate(across(c(estimate, std.error, conf.low, conf.high),
                ~ifelse(term %in% c("gdpPercap_z", "sd__gdpPercap_z"), 
                        (. / gdp_sd) * 1000, .)))
## # A tibble: 7 × 8
##   effect   component group    term                   estimate std.error conf.low conf.high
##   <chr>    <chr>     <chr>    <chr>                     <dbl>     <dbl>    <dbl>     <dbl>
## 1 fixed    cond      <NA>     (Intercept)              57.3     1.17     55.1       59.7  
## 2 fixed    cond      <NA>     gdpPercap_z               1.17    0.197     0.822      1.60 
## 3 fixed    cond      <NA>     year                      0.310   0.00609   0.298      0.322
## 4 ran_pars cond      country  sd__(Intercept)           9.98    0.930     8.33      12.0  
## 5 ran_pars cond      country  sd__gdpPercap_z           1.74    0.211     1.34       2.18 
## 6 ran_pars cond      country  cor__(Intercept).gdpP…    0.201   0.146    -0.0995     0.469
## 7 ran_pars cond      Residual sd__Observation           2.92    0.0587    2.81       3.04

tidy(model_gdp_country_only_log) %>% 
  mutate(across(c(estimate, std.error, conf.low, conf.high),
                ~ifelse(term %in% c("gdpPercap_log_z", "sd__gdpPercap_log_z"), 
                        (. / gdp_log_sd), .)))
## # A tibble: 7 × 8
##   effect   component group    term                   estimate std.error conf.low conf.high
##   <chr>    <chr>     <chr>    <chr>                     <dbl>     <dbl>    <dbl>     <dbl>
## 1 fixed    cond      <NA>     (Intercept)              53.7     0.960     51.7     55.5   
## 2 fixed    cond      <NA>     gdpPercap_log_z           3.41    0.577      2.30     4.58  
## 3 fixed    cond      <NA>     year                      0.283   0.00638    0.271    0.296 
## 4 ran_pars cond      country  sd__(Intercept)          11.2     0.755      9.81    12.8   
## 5 ran_pars cond      country  sd__gdpPercap_log_z       5.69    0.441      4.87     6.56  
## 6 ran_pars cond      country  cor__(Intercept).gdpP…   -0.281   0.102     -0.470   -0.0749
## 7 ran_pars cond      Residual sd__Observation           2.76    0.0532     2.66     2.87
```

###Country-level random effects
```{r}
ranef(model_gdp_country_only)$country %>%
  as_tibble(rownames = "country") %>% 
  filter(country %in% countries$country) %>% 
  select(country, starts_with("Estimate")) %>% 
  # Unscale the GDP offsets
  mutate(Estimate.gdpPercap_z = Estimate.gdpPercap_z / gdp_sd * 1000)
## # A tibble: 8 × 3
##   country      Estimate.Intercept Estimate.gdpPercap_z
##   <chr>                     <dbl>                <dbl>
## 1 Bolivia                  -0.720                1.89 
## 2 Canada                   11.5                 -1.34 
## 3 Egypt                     1.73                 1.67 
## 4 Italy                     8.77                -1.24 
## 5 Pakistan                  0.703                0.897
## 6 Portugal                  4.22                -1.09 
## 7 Sierra Leone             -9.64                 2.06 
## 8 Yemen, Rep.               9.59                 4.05
```

```{r}
coef(model_gdp_country_only)$country %>%
  as_tibble(rownames = "country") %>% 
  filter(country %in% countries$country) %>% 
  select(country, starts_with("Estimate")) %>% 
  # Unscale the GDP offsets
  mutate(Estimate.gdpPercap_z = Estimate.gdpPercap_z / gdp_sd * 1000)
## # A tibble: 8 × 4
##   country      Estimate.Intercept Estimate.gdpPercap_z Estimate.year
##   <chr>                     <dbl>                <dbl>         <dbl>
## 1 Bolivia                    56.6               3.07           0.310
## 2 Canada                     68.8              -0.166          0.310
## 3 Egypt                      59.0               2.84           0.310
## 4 Italy                      66.1              -0.0702         0.310
## 5 Pakistan                   58.0               2.07           0.310
## 6 Portugal                   61.5               0.0820         0.310
## 7 Sierra Leone               47.7               3.23           0.310
## 8 Yemen, Rep.                66.9               5.22           0.310
```

```{r}
ame_model_gdp_country_only <- model_gdp_country_only %>% 
  emtrends(~ country,
           var = "gdpPercap_z",
           at = list(year = 0, country = countries$country),
           epred = TRUE, re_formula = NULL)

pred_ame_model_gdp_country_only <- ame_model_gdp_country_only %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = .value / gdp_sd * 1000) %>% 
  left_join(countries, by = "country")

ggplot(pred_ame_model_gdp_country_only, aes(x = .value)) +
  stat_halfeye(aes(fill = continent)) +
  geom_vline(xintercept = 0) +
  scale_fill_okabe_ito(order = c(2, 3, 6, 1), guide = "none") +
  labs(title = paste0("Average marginal effect of GDP per capita", "\n",
                      "(intercepts and slope of GDP per capita by country)"), 
       subtitle = "lifeExp ~ gdpPercap_z + year + (1 + gdpPercap_z | country)",
       x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a $1,000 increase in GDP per capita"), 
       y = "Density",
       caption = "80% and 95% credible intervals shown with error bar") +
  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings) +
  theme_clean() +
  theme(plot.subtitle = element_text(family = "Consolas"))
```

###⭐ Each country gets its own intercept and GDP and year slopes ⭐

```{r}
model_gdp_country_year <- brm(
  bf(lifeExp ~ gdpPercap_z + year + (1 + gdpPercap_z + year | country),
     decomp = "QR"),
  data = gapminder,
  chains = 4, seed = bayes_seed,
  threads = threading(2)  # Two CPUs per chain to speed things up
)
## Start sampling

model_gdp_country_year_log <- brm(
  bf(lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_log_z + year | country),
     decomp = "QR"),
  data = gapminder,
  chains = 4, seed = bayes_seed,
  threads = threading(2)  # Two CPUs per chain to speed things up
)
## Start sampling
```

```{r}
# Model with regular GDP per capita
rstan::get_elapsed_time(model_gdp_country_year$fit) %>% 
  as_tibble(rownames = "chain") %>% mutate(total_seconds = warmup + sample)
## # A tibble: 4 × 4
##   chain   warmup sample total_seconds
##   <chr>    <dbl>  <dbl>         <dbl>
## 1 chain:1   32.9   53.5          86.4
## 2 chain:2   33.8   49.1          82.9
## 3 chain:3   34.2   30.0          64.2
## 4 chain:4   39.5   29.0          68.5

# Model with logged GDP per capita 
rstan::get_elapsed_time(model_gdp_country_year_log$fit) %>% 
  as_tibble(rownames = "chain") %>% mutate(total_seconds = warmup + sample)
## # A tibble: 4 × 4
##   chain   warmup sample total_seconds
##   <chr>    <dbl>  <dbl>         <dbl>
## 1 chain:1   20.9   16.8          37.7
## 2 chain:2   21.5   17.2          38.7
## 3 chain:3   21.4   16.9          38.3
## 4 chain:4   21.2   17.1          38.3
```

```{r}
# Bad R-hats and low effective sample sizes
bayestestR::diagnostic_posterior(model_gdp_country_year)
##       Parameter Rhat   ESS     MCSE
## 1 b_gdpPercap_z 1.05  85.3 0.119554
## 2   b_Intercept 1.03 253.6 0.067100
## 3        b_year 1.00 981.7 0.000516

# Okay R-hats and okay-ish effective sample sizes
bayestestR::diagnostic_posterior(model_gdp_country_year_log)
##           Parameter Rhat  ESS     MCSE
## 1 b_gdpPercap_log_z 1.00 1707 0.012333
## 2       b_Intercept 1.01  379 0.046063
## 3            b_year 1.00  625 0.000732
```

```{r}
# Unscale both the GDP coefficient and the GDP random variance coefficient
tidy(model_gdp_country_year) %>% 
  mutate(across(c(estimate, std.error, conf.low, conf.high),
                ~ifelse(term %in% c("gdpPercap_z", "sd__gdpPercap_z"), 
                        (. / gdp_sd) * 1000, .)))
## # A tibble: 10 × 8
##    effect   component group    term                  estimate std.error conf.low conf.high
##    <chr>    <chr>     <chr>    <chr>                    <dbl>     <dbl>    <dbl>     <dbl>
##  1 fixed    cond      <NA>     (Intercept)             52.6      1.07     50.5      54.7  
##  2 fixed    cond      <NA>     gdpPercap_z              0.448    0.112     0.263     0.691
##  3 fixed    cond      <NA>     year                     0.318    0.0162    0.287     0.349
##  4 ran_pars cond      country  sd__(Intercept)         11.1      0.726     9.84     12.7  
##  5 ran_pars cond      country  sd__gdpPercap_z          0.685    0.209     0.298     1.04 
##  6 ran_pars cond      country  sd__year                 0.174    0.0122    0.152     0.200
##  7 ran_pars cond      country  cor__(Intercept).gdp…   -0.162    0.224    -0.632     0.176
##  8 ran_pars cond      country  cor__(Intercept).year   -0.587    0.0803   -0.730    -0.419
##  9 ran_pars cond      country  cor__gdpPercap_z.year   -0.470    0.0997   -0.644    -0.257
## 10 ran_pars cond      Residual sd__Observation          2.08     0.0579    1.98      2.21

tidy(model_gdp_country_year_log) %>% 
  mutate(across(c(estimate, std.error, conf.low, conf.high),
                ~ifelse(term %in% c("gdpPercap_log_z", "sd__gdpPercap_log_z"), 
                        (. / gdp_log_sd), .)))
## # A tibble: 10 × 8
##    effect   component group    term                  estimate std.error conf.low conf.high
##    <chr>    <chr>     <chr>    <chr>                    <dbl>     <dbl>    <dbl>     <dbl>
##  1 fixed    cond      <NA>     (Intercept)             52.1      0.897    50.3      53.8  
##  2 fixed    cond      <NA>     gdpPercap_log_z          4.27     0.413     3.46      5.06 
##  3 fixed    cond      <NA>     year                     0.258    0.0183    0.222     0.294
##  4 ran_pars cond      country  sd__(Intercept)         10.5      0.718     9.14     12.0  
##  5 ran_pars cond      country  sd__gdpPercap_log_z      3.28     0.384     2.54      4.05 
##  6 ran_pars cond      country  sd__year                 0.202    0.0146    0.174     0.232
##  7 ran_pars cond      country  cor__(Intercept).gdp…    0.385    0.114     0.146     0.593
##  8 ran_pars cond      country  cor__(Intercept).year   -0.712    0.0480   -0.796    -0.609
##  9 ran_pars cond      country  cor__gdpPercap_log_z…   -0.694    0.0700   -0.814    -0.546
## 10 ran_pars cond      Residual sd__Observation          1.97     0.0411    1.89      2.05
```

Country-level variation and random effects
```{r}
coef(model_gdp_country_year)$country %>%
  as_tibble(rownames = "country") %>% 
  filter(country %in% countries$country) %>% 
  select(country, starts_with("Estimate")) %>% 
  # Unscale the GDP offsets
  mutate(Estimate.gdpPercap_z = Estimate.gdpPercap_z / gdp_sd * 1000)
## # A tibble: 8 × 4
##   country      Estimate.Intercept Estimate.gdpPercap_z Estimate.year
##   <chr>                     <dbl>                <dbl>         <dbl>
## 1 Bolivia                    40.5               0.343          0.487
## 2 Canada                     68.5               0.0602         0.196
## 3 Egypt                      42.9               0.277          0.525
## 4 Italy                      66.7               0.0664         0.241
## 5 Pakistan                   47.0               0.479          0.385
## 6 Portugal                   61.3               0.0401         0.323
## 7 Sierra Leone               39.8               1.53           0.226
## 8 Yemen, Rep.                34.0               0.547          0.576
```


```{r}
ame_model_gdp_country_year <- model_gdp_country_year %>% 
  emtrends(~ year + country,
           var = "gdpPercap_z",
           at = list(year = 0, country = countries$country),
           epred = TRUE, re_formula = NULL)

pred_ame_model_gdp_country_year <- ame_model_gdp_country_year %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = .value / gdp_sd * 1000) %>% 
  left_join(countries, by = "country")

ggplot(pred_ame_model_gdp_country_year, aes(x = .value)) +
  stat_halfeye(aes(fill = continent)) +
  geom_vline(xintercept = 0) +
  scale_fill_okabe_ito(order = c(2, 3, 6, 1), guide = "none") +
  labs(title = paste0("Average marginal effect of GDP per capita", "\n",
                      "(intercepts and slopes of both GDP per capita and year vary by country)"), 
       subtitle = "lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_z + year | country)",
       x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a $1,000 increase in GDP per capita"), 
       y = "Density",
       caption = "80% and 95% credible intervals shown with error bar") +
  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings) +
  theme_clean() +
  theme(plot.subtitle = element_text(family = "Consolas"))
```



```{r}
ame_model_gdp_country_year_log <- model_gdp_country_year_log %>% 
  emtrends(~ year + country,
           var = "gdpPercap_log_z",
           at = list(year = 0, country = countries$country),
           epred = TRUE, re_formula = NULL)

pred_ame_model_gdp_country_year_log <- ame_model_gdp_country_year_log %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = .value / gdp_log_sd / 10) %>% 
  left_join(countries, by = "country")

ggplot(pred_ame_model_gdp_country_year_log, aes(x = .value)) +
  stat_halfeye(aes(fill = continent)) +
  geom_vline(xintercept = 0) +
  scale_fill_okabe_ito(order = c(2, 3, 6, 1), guide = "none") +
  labs(title = paste0("Average marginal effect of GDP per capita", "\n",
                      "(intercepts and slopes of both GDP per capita and year vary by country)"), 
       subtitle = "lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_log_z + year | country)",
       x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a 10% increase in GDP per capita"), 
       y = "Density",
       caption = "80% and 95% credible intervals shown with error bar") +
  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings) +
  theme_clean() +
  theme(plot.subtitle = element_text(family = "Consolas"))
```


```{r}
# Calculate the overall global effect
# `re_formula = NA` means that no random effects will be incorporated
ame_global_gdp_country_year <- model_gdp_country_year_log %>% 
  emtrends(~ 1,
           var = "gdpPercap_log_z",
           epred = TRUE, re_formula = NA)
ame_global_gdp_country_year
##  1       gdpPercap_log_z.trend lower.HPD upper.HPD
##  overall                  5.27      4.32      6.29
## 
## Point estimate displayed: median 
## HPD interval probability: 0.95

# Get the posterior distribution of this global effect and make a plot
pred_global_gdp_country_year <- ame_global_gdp_country_year %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = (.value / gdp_log_sd) / 10) %>% 
  mutate(fake_facet_title = "Global grand mean")

plot_global_gdp_country_year <- ggplot(pred_global_gdp_country_year, aes(x = .value)) +
  stat_halfeye(fill = palette_okabe_ito(5)) +
  geom_vline(xintercept = 0) +
  labs(x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a 10% increase in GDP per capita"), 
       y = "Density") +
  facet_wrap(vars(fake_facet_title)) +
  theme_clean() +
  theme(strip.text = element_text(size = rel(1.1)))

# Calculate the effect for Atlantis
# `re_formula = NULL` means the full random effects structure will be
# incorporated. `allow_new_levels` lets R deal with a new country, and
# `sample_new_levels = "gaussian"` means that the characteristics for this new
# country will be based on random draws from the model
ame_hypo_gdp_country_year <- model_gdp_country_year_log %>% 
  emtrends(~ 1 + country,
           var = "gdpPercap_log_z",
           at = list(country = "Atlantis"),
           epred = TRUE, re_formula = NULL, 
           allow_new_levels = TRUE, sample_new_levels = "gaussian")
ame_hypo_gdp_country_year
##  country  gdpPercap_log_z.trend lower.HPD upper.HPD
##  Atlantis                  5.14     -2.93      13.5
## 
## Point estimate displayed: median 
## HPD interval probability: 0.95

# Get the posterior distribution of this Atlantis effect and make a plot
pred_hypo_gdp_country_year <- ame_hypo_gdp_country_year %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = (.value / gdp_log_sd) / 10) %>% 
  mutate(fake_facet_title = "AME for hypothetical Atlantis")

plot_hypo_gdp_country_year <- ggplot(pred_hypo_gdp_country_year, aes(x = .value)) +
  stat_halfeye(fill = palette_okabe_ito(7)) +
  geom_vline(xintercept = 0) +
  labs(x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a 10% increase in GDP per capita"), 
       y = "Density") +
  facet_wrap(vars(fake_facet_title)) +
  theme_clean() +
  theme(strip.text = element_text(size = rel(1.1)))

# Show the two AME distributions side-by-side
(plot_global_gdp_country_year | plot_hypo_gdp_country_year) +
  plot_annotation(title = paste0("Average marginal effect of GDP per capita", "\n",
                                 "(intercepts and slopes of both GDP per capita and year vary by country)"), 
                  subtitle = "lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_log_z + year | country)",
                  caption = "80% and 95% credible intervals shown with error bar",
                  theme = theme_clean() + theme(plot.subtitle = element_text(family = "Consolas")))
```


Each country gets its own intercept and GDP and year slopes and year-specific offsets in the GDP slope
```{r}
model_gdp_country_year_year <- brm(
  bf(lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_log_z | year) + 
       (1 + gdpPercap_log_z + year | country),
     decomp = "QR"),
  data = gapminder,
  cores = 4, chains = 4, seed = bayes_seed,
  threads = threading(2)  # Two CPUs per chain to speed things up
)
## Start sampling
```



```{r}
rstan::get_elapsed_time(model_gdp_country_year_year$fit) %>% 
  as_tibble(rownames = "chain") %>% mutate(total_seconds = warmup + sample)
## # A tibble: 4 × 4
##   chain   warmup sample total_seconds
##   <chr>    <dbl>  <dbl>         <dbl>
## 1 chain:1   32.4   18.4          50.8
## 2 chain:2   32.9   18.4          51.3
## 3 chain:3   44.9   19.8          64.7
## 4 chain:4   31.7   21.1          52.9
```

```{r}
# Unscale both the GDP coefficient and the GDP random variance coefficient
tidy(model_gdp_country_year_year) %>% 
  mutate(across(c(estimate, std.error, conf.low, conf.high),
                ~ifelse(term %in% c("gdpPercap_log_z", "sd__gdpPercap_log_z"), 
                        (. / gdp_log_sd), .)))
## # A tibble: 13 × 8
##    effect   component group    term                  estimate std.error conf.low conf.high
##    <chr>    <chr>     <chr>    <chr>                    <dbl>     <dbl>    <dbl>     <dbl>
##  1 fixed    cond      <NA>     (Intercept)             52.4      1.13   50.2        54.7  
##  2 fixed    cond      <NA>     gdpPercap_log_z          3.32     0.407   2.53        4.09 
##  3 fixed    cond      <NA>     year                     0.258    0.0250  0.208       0.307
##  4 ran_pars cond      country  sd__(Intercept)         10.6      0.718   9.26       12.1  
##  5 ran_pars cond      country  sd__gdpPercap_log_z      2.81     0.348   2.15        3.52 
##  6 ran_pars cond      country  sd__year                 0.192    0.0135  0.168       0.220
##  7 ran_pars cond      year     sd__(Intercept)          0.959    0.265   0.592       1.59 
##  8 ran_pars cond      year     sd__gdpPercap_log_z      0.266    0.103   0.118       0.518
##  9 ran_pars cond      country  cor__(Intercept).gdp…    0.276    0.129   0.00566     0.526
## 10 ran_pars cond      country  cor__(Intercept).year   -0.645    0.0552 -0.746      -0.529
## 11 ran_pars cond      country  cor__gdpPercap_log_z…   -0.678    0.0734 -0.803      -0.517
## 12 ran_pars cond      year     cor__(Intercept).gdp…   -0.826    0.172  -0.994      -0.337
## 13 ran_pars cond      Residual sd__Observation          1.80     0.0370  1.73        1.87
```

```{r}
coef(model_gdp_country_year)$country %>%
  as_tibble(rownames = "country") %>% 
  filter(country %in% countries$country) %>% 
  select(country, starts_with("Estimate")) %>% 
  # Unscale the GDP offsets
  mutate(Estimate.gdpPercap_z = Estimate.gdpPercap_z / gdp_sd * 1000)
## # A tibble: 8 × 4
##   country      Estimate.Intercept Estimate.gdpPercap_z Estimate.year
##   <chr>                     <dbl>                <dbl>         <dbl>
## 1 Bolivia                    40.5               0.343          0.487
## 2 Canada                     68.5               0.0602         0.196
## 3 Egypt                      42.9               0.277          0.525
## 4 Italy                      66.7               0.0664         0.241
## 5 Pakistan                   47.0               0.479          0.385
## 6 Portugal                   61.3               0.0401         0.323
## 7 Sierra Leone               39.8               1.53           0.226
## 8 Yemen, Rep.                34.0               0.547          0.576
```

```{r}
# Different slopes in each year!
model_gdp_country_year_year %>% 
  emtrends(~ year + country,
           var = "gdpPercap_log_z",
           at = list(year = c(0, 5), country = countries$country),
           epred = TRUE, re_formula = NULL)
##  year country      gdpPercap_log_z.trend lower.HPD upper.HPD
##     0 Egypt                         0.96     -4.49      7.03
##     5 Egypt                         0.81     -4.95      6.56
##     0 Sierra Leone                  4.70      1.18      8.08
##     5 Sierra Leone                  4.53      1.05      7.93
##     0 Pakistan                      3.95     -1.40      9.39
##     5 Pakistan                      3.82     -1.45      9.27
##     0 Yemen, Rep.                   2.37     -2.21      7.09
##     5 Yemen, Rep.                   2.24     -2.47      6.85
##     0 Bolivia                       1.88     -2.49      6.60
##     5 Bolivia                       1.73     -2.64      6.44
##     0 Canada                        5.79      0.39     11.73
##     5 Canada                        5.65      0.11     11.42
##     0 Italy                         4.93     -1.02     10.33
##     5 Italy                         4.78     -0.92     10.35
##     0 Portugal                      5.35     -0.57     10.77
##     5 Portugal                      5.21     -0.44     10.83
## 
## Point estimate displayed: median 
## HPD interval probability: 0.95
```

```{r}
ame_model_gdp_country_year_year <- model_gdp_country_year_year %>% 
  emtrends(~ year + country,
           var = "gdpPercap_log_z",
           at = list(year = seq(0, 55, by = 5), country = countries$country),
           epred = TRUE, re_formula = NULL)

pred_model_gdp_country_year_year <- ame_model_gdp_country_year_year %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = (.value / gdp_log_sd) / 10) %>% 
  mutate(year = year + 1952,
         year = fct_inorder(factor(year))) %>%
  left_join(countries, by = "country")

ggplot(pred_model_gdp_country_year_year, aes(x = .value, fill = year)) +
  stat_slab(aes(y = fct_rev(year), fill = year,
                fill_ramp = stat(cut_cdf_qi(cdf, .width = c(0.02, 0.8, 0.95, 1)))),
            height = 2, color = "white", slab_size = 0.5) +
  scale_fill_viridis_d(option = "rocket", guide = "none", end = 0.9) +
  scale_fill_ramp_discrete(range = c(1, 0.2), guide = "none") +
  geom_vline(xintercept = 0) +
  labs(title = paste0("Average marginal effect of GDP per capita", "\n",
                      "(intercepts and slopes of both GDP per capita and year ",
                      "vary by country + intercepts vary by year)"), 
       subtitle = paste0("lifeExp ~ gdpPercap_log_z + year + ", 
                         "(1 + gdpPercap_log_z | year) + ", 
                         "(1 + gdpPercap_log_z + year | country)"),
       x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a 10% increase in GDP per capita"), 
       y = "Year",
       caption = "80% and 95% credible intervals shown with shading") +
  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings,
                    scales = "free_x") +
  theme_clean() +
  theme(panel.grid.major.y = element_blank(),
        plot.subtitle = element_text(family = "Consolas"))
```

```{r}
# Calculate the overall global effect
# `re_formula = NA` means that no random effects will be incorporated
ame_global_gdp_country_year_year <- model_gdp_country_year_year %>% 
  emtrends(~ 1,
           var = "gdpPercap_log_z",
           epred = TRUE, re_formula = NA)

# Get the posterior distribution of this global effect and make a plot
pred_global_gdp_country_year_year <- ame_global_gdp_country_year_year %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = (.value / gdp_log_sd) / 10) %>% 
  mutate(fake_facet_title = "Global grand mean")

plot_global_gdp_country_year_year <- ggplot(pred_global_gdp_country_year_year, aes(x = .value)) +
  stat_slab(aes(fill_ramp = stat(cut_cdf_qi(cdf, .width = c(0.02, 0.8, 0.95, 1)))),
            fill = palette_okabe_ito(5)) +
  scale_fill_viridis_d(option = "plasma", guide = "none", begin = 0.5) +
  scale_fill_ramp_discrete(range = c(1, 0.2), guide = "none") +
  geom_vline(xintercept = 0) +
  labs(x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a 10% increase in GDP per capita"), 
       y = "Density") +
  facet_wrap(vars(fake_facet_title)) +
  theme_clean() +
  theme(panel.grid.major.y = element_blank(),
        strip.text = element_text(size = rel(1.1)))

# Calculate the effect for Atlantis in 2020
# `re_formula = NULL` means the full random effects structure will be
# incorporated. `allow_new_levels` lets R deal with a new country, and
# `sample_new_levels = "gaussian"` means that the characteristics for this new
# country will be based on random draws from the model
ame_hypo1_gdp_country_year_year <- model_gdp_country_year_year %>% 
  emtrends(~ country + year,
           var = "gdpPercap_log_z",
           at = list(year = (2020 - 1952), country = "Atlantis"),
           epred = TRUE, re_formula = NULL, 
           allow_new_levels = TRUE, sample_new_levels = "gaussian")

# Atlantis median 2020 effect
ame_hypo1_gdp_country_year_year %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = (.value / gdp_log_sd) / 10) %>% 
  median_hdci()
## # A tibble: 1 × 8
##   country   year .value .lower .upper .width .point .interval
##   <fct>    <dbl>  <dbl>  <dbl>  <dbl>  <dbl> <chr>  <chr>    
## 1 Atlantis    68  0.331 -0.220  0.903   0.95 median hdci

# Get the posterior distribution of this Atlantis effect and make a plot
pred_hypo1_gdp_country_year_year <- ame_hypo1_gdp_country_year_year %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = (.value / gdp_log_sd) / 10) %>% 
  mutate(fake_facet_title = "AME for hypothetical Atlantis in 2020")

plot_hypo1_gdp_country_year_year <- ggplot(pred_hypo1_gdp_country_year_year, aes(x = .value)) +
  stat_slab(aes(fill_ramp = stat(cut_cdf_qi(cdf, .width = c(0.02, 0.8, 0.95, 1)))),
            fill = palette_okabe_ito(7)) +
  scale_fill_ramp_discrete(range = c(1, 0.2), guide = "none") +
  geom_vline(xintercept = 0) +
  labs(x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a 10% increase in GDP per capita"), 
       y = "Density") +
  facet_wrap(vars(fake_facet_title)) +
  theme_clean() +
  theme(panel.grid.major.y = element_blank(),
        strip.text = element_text(size = rel(1.1)))

# Calculate the effect for Atlantis across all existing years
ame_hypo_gdp_country_year_year <- model_gdp_country_year_year %>% 
  emtrends(~ country + year,
           var = "gdpPercap_log_z",
           at = list(year = seq(0, 55, by = 5), country = "Atlantis"),
           epred = TRUE, re_formula = NULL, 
           allow_new_levels = TRUE, sample_new_levels = "gaussian")

# Get the posterior distribution of this Atlantis effect and make a plot
pred_hypo_gdp_country_year_year <- ame_hypo_gdp_country_year_year %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = (.value / gdp_log_sd) / 10) %>% 
  mutate(year = year + 1952,
         year = fct_inorder(factor(year))) %>%
  mutate(fake_facet_title = "AME for hypothetical Atlantis across time")

plot_hypo_gdp_country_year_year <- ggplot(pred_hypo_gdp_country_year_year, aes(x = .value)) +
  stat_slab(aes(y = fct_rev(year), fill = year,
                fill_ramp = stat(cut_cdf_qi(cdf, .width = c(0.02, 0.8, 0.95, 1)))),
            height = 2, color = "white") +
  scale_fill_viridis_d(option = "rocket", guide = "none", end = 0.9) +
  scale_fill_ramp_discrete(range = c(1, 0.2), guide = "none") +
  geom_vline(xintercept = 0) +
  labs(x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a 10% increase in GDP per capita"), 
       y = "Year") +
  facet_wrap(vars(fake_facet_title)) +
  theme_clean() +
  theme(panel.grid.major.y = element_blank(),
        strip.text = element_text(size = rel(1.1)))

# Show all the AME distributions in a mega plot
((plot_global_gdp_country_year_year / plot_hypo1_gdp_country_year_year) | 
    plot_hypo_gdp_country_year_year) +
  plot_annotation(title = paste0("Average marginal effect of GDP per capita", "\n",
                                 "(intercepts and slopes of both GDP per capita and year ",
                                 "vary by country + intercepts and GDP slopes vary by year)"), 
                  subtitle = paste0("lifeExp ~ gdpPercap_log_z + year + ", 
                         "(1 + gdpPercap_log_z | year) + ", 
                         "(1 + gdpPercap_log_z + year | country)"),
                  caption = "80% and 95% credible intervals shown with shading",
                  theme = theme_clean() + theme(plot.subtitle = element_text(family = "Consolas")))
```

Each continent and nested country gets its own intercept and GDP and year slopes
```{r}
model_gdp_continent_country_year <- brm(
  bf(lifeExp ~ gdpPercap_log_z + year + 
       (1 + gdpPercap_log_z + year | continent / country),
     decomp = "QR"),
  data = gapminder,
  cores = 4, chains = 4, seed = bayes_seed,
  threads = threading(2)  # Two CPUs per chain to speed things up
)
```

```{r}
# You'd use this to calculate the continent/country specific effects
model_gdp_continent_country_year %>%
  emtrends(~ year + continent:country,
           var = "gdpPercap_log_z",
           at = list(year = c(0), country = countries$country),
           nesting = "country %in% continent",
           epred = TRUE, re_formula = NULL, allow_new_levels = TRUE)
```

```{r}
fit <- lme4::lmer(
  weight ~ 1 + Time + I(Time^2) + Diet + Time:Diet + I(Time^2:Diet) + 
    (1 + Time + I(Time^2) | Chick),
  data = ChickWeight
)
```

```{r}
bf(outcome ~ x + year + (1 | country))
```

```{r}
bf(outcome ~ x + year + (1 + year | country))
```

```{r}
bf(outcome ~ x + year + (1 + x + year | country))

```

```{r}
bf(outcome ~ x + year + (1 | year) + (1 + x + year | country))
```

```{r}
bf(outcome ~ x + year + (1 + x + year | continent / country))
```

```{r}
bf(outcome ~ x + year + (1 + x | year) + (1 + x + year | continent / country))
```

```{r}
```

```{r}
```

```{r}
```