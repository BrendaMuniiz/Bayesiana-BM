---
title: "Prova 2 - Inferência Bayesiana"
author:
  - Brenda da Silva Muniz 11811603
  - Mônica Amaral Novelli 11810453
date: "Janeiro 2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Introdução 

  O propósito principal do nosso trabalho é explorar a relação entre riqueza e saúde - ou, em outros termos, PIB per capita e expectativa de vida a partir de um banco de dados retirado da biblioteca *gapminder*. Nossa hipótese inicial é de que a expectativa de vida aumenta conforme a riqueza aumenta, mas isso difere dependendo do país analisado.  Para isso, utilizaremos a abordagem bayesiana em modelos multiníveis relativos a dados de países por anos. Na metodologia (item 1) referenciaremos os motivos para a escolha desse, tal qual uma comparação com outros tipos de modelos.
  
Abaixo, seguem todas as predefinições utilizadas para a montagem do código:

```{r}

library(tidyverse)    # ggplot, dplyr, %>%, and friends
library(gapminder)    # Country-year panel data from the Gapminder Project
library(brms)         # Bayesian modeling through Stan
library(tidybayes)    # Manipulate Stan objects in a tidy way
library(broom)        # Convert model objects to data frames
library(broom.mixed)  # Convert brms model objects to data frames
library(emmeans)      # Calculate marginal effects in even fancier ways
library(ggh4x)        # For nested facets in ggplot
library(ggrepel)      # For nice non-overlapping labels in ggplot
library(ggdist)       # For distribution-related ggplot geoms
library(scales)       # For formatting numbers with comma(), dollar(), etc.
library(patchwork)    # For combining plots
library(ggokabeito)   # Colorblind-friendly color palette
```

```{r}
# Make all the random draws reproducible
set.seed(1234)

# Bayes stuff
# Use the cmdstanr backend for Stan because it's faster and more modern than
# the default rstan. You need to install the cmdstanr package first
# (https://mc-stan.org/cmdstanr/) and then run cmdstanr::install_cmdstan() to
# install cmdstan on your computer.
options(mc.cores = 4,  # Use 4 cores
        brms.backend = "cmdstanr")
bayes_seed <- 1234

# Custom ggplot theme to make pretty plots
# Get Barlow Semi Condensed at https://fonts.google.com/specimen/Barlow+Semi+Condensed
theme_clean <- function() {
  theme_minimal(base_family = "Barlow Semi Condensed") +
    theme(panel.grid.minor = element_blank(),
          plot.background = element_rect(fill = "white", color = NA),
          plot.title = element_text(face = "bold"),
          axis.title = element_text(face = "bold"),
          strip.text = element_text(face = "bold", size = rel(0.8), hjust = 0),
          strip.background = element_rect(fill = "grey80", color = NA),
          legend.title = element_text(face = "bold"))
}

# Make labels use Barlow by default
update_geom_defaults("label_repel", 
                     list(family = "Barlow Semi Condensed",
                          fontface = "bold"))
update_geom_defaults("label", 
                     list(family = "Barlow Semi Condensed",
                          fontface = "bold"))

# The ggh4x paackage includes a `facet_nested()` function for nesting facets
# (like countries in continents). Throughout this post, I want the
# continent-level facets to use bolder text and a lighter gray strip. I don't
# want to keep repeating all these settings, though, so I create a list of the
# settings here with `strip_nested()` and feed it to `facet_nested_wrap()` later
nested_settings <- strip_nested(
  text_x = list(element_text(family = "Barlow Semi Condensed Black", 
                             face = "plain"), NULL),
  background_x = list(element_rect(fill = "grey92"), NULL),
  by_layer_x = TRUE)
```

```{r}
# Little dataset of 8 countries (2 for each of the 4 continents in the data)
# that are good examples of different trends and intercepts
countries <- tribble(
  ~country,       ~continent,
  "Egypt",        "Africa",
  "Sierra Leone", "Africa",
  "Pakistan",     "Asia",
  "Yemen, Rep.",  "Asia",
  "Bolivia",      "Americas",
  "Canada",       "Americas",
  "Italy",        "Europe",
  "Portugal",     "Europe"
)

# Clean up the gapminder data a little
gapminder <- gapminder::gapminder %>%
  # Remove Oceania since there are only two countries there and we want bigger
  # continent clusters
  filter(continent != "Oceania") %>%
  # Scale down GDP per capita so it's more interpretable ("a $1,000 increase in
  # GDP" vs. "a $1 increase in GDP")
  # Also log it
  mutate(gdpPercap_1000 = gdpPercap / 1000,
         gdpPercap_log = log(gdpPercap)) %>% 
  mutate(across(starts_with("gdp"), list("z" = ~scale(.)))) %>% 
  # Make year centered on 1952 (so we're counting the years since 1952). This
  # (1) helps with interpretability, since the intercept will show the average
  # at 1952 instead of the average at 0 CE, and (2) helps with estimation speed
  # since brms/Stan likes to work with small numbers
  mutate(year_orig = year,
         year = year - 1952) %>% 
  # Indicator for the 8 countries we're focusing on
  mutate(highlight = country %in% countries$country)

# Extract rows for the example countries
original_points <- gapminder %>% 
  filter(country %in% countries$country) %>% 
  # Use real years
  mutate(year = year_orig)
```

```{r}
glimpse(gapminder)
```

# Descrição e análise dos dados

  Podemos fazer uma breve análise descritiva dos nossos dados para melhor visualização das trajetórias ao longo do tempo de cada país. 

```{r}
ggplot(gapminder, aes(x = gdpPercap, y = lifeExp, color = continent)) + 
  geom_point(size = 0.5, alpha = 0.25) +
  geom_smooth(method = "lm", aes(color = NULL), color = "grey60", size = 0.5, 
              se = FALSE, show.legend = FALSE) +
  annotate(geom = "label", label = "Global trend", x = 64000, y = 84, 
           size = 3, color = "grey60") +
  geom_path(aes(group = country, size = highlight),
            arrow = arrow(type = "open", angle = 30, length = unit(0.75, "lines")),
            show.legend = FALSE) +
  geom_label_repel(data = filter(gapminder, year == 15, highlight == TRUE), 
                   aes(label = country), size = 3, seed = 1234, 
                   show.legend = FALSE,
                   family = "Barlow Semi Condensed", fontface = "bold") +
  scale_size_manual(values = c(0.075, 1), guide = "none") +
  scale_color_okabe_ito(order = c(2, 3, 6, 1),
                        guide = guide_legend(override.aes = list(size = 3, alpha = 1))) +
  scale_x_log10(labels = dollar_format(accuracy = 1), breaks = 125 * (2^(1:10))) +
  labs(x = "GDP per capita (log)", y = "Life expectancy", color = "Continent") +
  theme_clean() +
  theme(legend.position = "bottom")
```

  Há alguns países com trajetórias mais estáveis, próximas a um aumento linear, como é o caso da Itália e de Portugal, por exemplo. Porém, também é possível notar países cujo aumentos da expectativa de vida ocorrem de forma brusca e acentuada - como é o caso da Bolívia. 
  Podemos por fim reparar no posicionamento da trajetória de cada país, que nos informa sobre o PIB per capita médio de cada continente. O continente europeu apresenta ambos de seus representantes no quadrante superior do gráfico, significando que a renda média desse país conta com valores altos - atingindo em seu máximo mais de 30 mil dólares, e tendo seu valor inicial próximo a 3 mil dólares. Entretanto, os continentes asiático e africano contam com todas suas trajetórias praticamente no quadrante inferior do gráfico, atingindo seu valor inicial antes da faixa dos mil dólares. 
  A linha cinza representada no gráfico ilustra a tendência global média, que indica que há uma correlação clara entre riqueza e saúde. Mas assim como descrito anteriormente, isso não pode ser generalizado para todos os países. Isso porque a inclinação de cada trajetória é particular e conta com aspectos além dos analisados: como visto, temos exemplos com a inclinação relativamente constante (Itália e Canadá), exemplos com inclinação íngremes (Bolívia) e ainda, trajetórias que não apresentam padrões claros, tendo pontos se que revertem (Serra Leoa). Desse modo, é importante que não tentemos analisar essa relação baseando-se apenas em um valor, e sim explorarmos como calcular e visualizar esses diferentes efeitos globais e específicos de cada país. O modo em que faremos isso será explorado no item 2 da Metodologia. 

# Metodologia

## Item 1:
### Como foi feita a escolha do modelo:

  Modelos multiníveis são modelos de regressão que incorporam efeitos específicos de grupo. Os grupos podem representar diferentes níveis de hierarquia. Presume-se que os efeitos específicos do grupo variam aleatoriamente de acordo com alguma distribuição a priori, geralmente uma distribuição normal. Essa suposição torna os modelos multiníveis candidatos naturais para uma análise bayesiana. Destaca-se, que os modelos multiníveis bayesianos assumem que outros parâmetros do modelo, tais como coeficientes de regressão e componentes de variância - variâncias de efeitos específicos de grupo - também são aleatórios.
  Vale ressaltar ainda, que quando o interesse principal de um problema está voltado para comparação de grupos, a modelagem multinível bayesiana pode fornecer distribuições inteiras de efeitos específicos de grupo.
Agora que já entendemos o funcionamento da modelagem multinível, vamos simplificar as coisas e olhar somente para a relação entre expectativa de vida/tempo e como essa relação difere entre continente e país. 

```{r}
ggplot(gapminder, aes(x = year_orig, y = lifeExp, 
                      group = country, color = continent)) +
  geom_line(aes(size = highlight)) +
  geom_smooth(method = "lm", aes(color = NULL, group = NULL), 
              color = "grey60", size = 1, linetype = "21",
              se = FALSE, show.legend = FALSE) +
  geom_label_repel(data = filter(gapminder, year == 0, highlight == TRUE), 
                   aes(label = country), direction = "y", size = 3, seed = 1234, 
                   show.legend = FALSE) +
  annotate(geom = "label", label = "Global trend", x = 1952, y = 50,
           size = 3, color = "grey60") +
  scale_size_manual(values = c(0.075, 1), guide = "none") +
  scale_color_okabe_ito(order = c(2, 3, 6, 1)) +
  labs(x = NULL, y = "Life expectancy", color = "Continent") +
  theme_clean() +
  theme(legend.position = "bottom")
## `geom_smooth()` using formula 'y ~ x'

```

  Através de uma breve análise, percebemos que a expectativa de vida de quase todos os países aumentou com o tempo. Todos os países têm diferentes pontos de partida ou interceptações em 1952. Além disso, diferenças específicas do continente influenciam essas interceptações, por exemplo, a Europa Ocidental tem uma expectativa de vida muito maior do que a África Subsaariana, e cada país tem suas próprias tendências ao longo do tempo. 
  A fim de exemplificar, é de fácil entendimento,a comparação do Egito, que começa em valores baixos e depois sobe rapidamente entre os anos 1970 e 1990, com o Canadá, que começa com valores já altos e termina mais alto ainda. Existem também países que observam tendências negativas ao longo do tempo, como Ruanda e Serra Leoa.
  Com o objetivo de facilitarmos nosso entendimento, começaremos a desenvolver  nossa metodologia com um modelo de regressão não multinível regular. Na verdade, executaremos dois  modelos diferentes: um com PIB per capita escalado e centralizado e outro com PIB per capita registrado em escala e centralizado, isto, para nos acostumarmos a aumentar os coeficientes.
  Esses modelos simples se encaixam perfeitamente em menos de um segundo, mas à medida que adicionamos mais complexidade, o PIB per capita não registrado fica muito instável e difícil de controlar, então mudaremos para a versão registrada.
  
```{r}

model_gdp_boring <- brm(
  bf(lifeExp ~ gdpPercap_z + year),
  data = gapminder,
  chains = 4, seed = bayes_seed
)

model_gdp_boring_log <- brm(
  bf(lifeExp ~ gdpPercap_log_z + year),
  data = gapminder,
  chains = 4, seed = bayes_seed
)

```

```{r}
tidy(model_gdp_boring)

tidy(model_gdp_boring_log)

```


  Como resultado, temos que os coeficientes para as variáveis em escala representam o aumento na expectativa de vida, a qual, segue um aumento de 1 desvio padrão no PIB per capita (não registrado e registrado). Mas, não pensamos em desvios padrões, por isso, optamos por deslocar esses coeficientes de volta às suas escalas originais. Para fazer isso, precisaremos dividir pelo desvio padrão das colunas originais. Também multiplicaremos o coeficiente do PIB per capita por 1.000 para que possamos falar sobre as mudanças na expectativa de vida que seguem um aumento de $ 1.000 na riqueza. E, por fim, dividiremos o coeficiente do PIB per capita registrado por 10 para que possamos falar sobre as mudanças na expectativa de vida, que segue um aumento de 10% na riqueza. Além disso, é esta combinação de across () e ifelse () dentro de mutate () que nos permite redimensionar várias colunas para apenas uma única linha. Todos os resultados dessas mudanças serão representadas visualmente nos gráficos expostos no item 1 dos resultados.
  
```{r}
tidy(model_gdp_boring) %>% 
  mutate(across(c(estimate, std.error, conf.low, conf.high),
                ~ifelse(term == "gdpPercap_z", (. / gdp_sd) * 1000, .)))

tidy(model_gdp_boring_log) %>% 
  mutate(across(c(estimate, std.error, conf.low, conf.high),
                ~ifelse(term == "gdpPercap_log_z", (. / gdp_log_sd), .)))

```

## Item 2:
### Como calcular e visualizar esses diferentes efeitos globais e específicos de cada país.

  Na nossa análise descritiva dos dados foi mencionada uma necessidade de calcular e visualizar os efeitos específicos de cada país. Para realizarmos isso, consideramos no nosso processo, primeiramente, a expectativa de vida média ao longo do tempo. Depois, traçamos a expectativa de vida prevista. Por fim, nos preocupamos com o efeito do PIB, trabalhando com um modelo (expVida ~ PIB)*, o qual poderemos visualizar posteriormente. Utilizaremos a distribuição  a posteriori desse coeficiente para estudarmos a variação específica de cada país. Também usaremos a função emtrends () da biblioteca emmeans, para que possamos calcular efeitos marginais médios instantâneos (Item 5).
Usaremos a versão centralizada do PIB per capita para acelerar o ajuste do modelo, o que significa que precisaremos remover a escala dos coeficientes para interpretá-los. Como um aumento de $1 não resulta em uma grande diferença na expectativa de vida, utilizaremos como nossa unidade de aumento de riqueza como sendo $1.000 no PIB per capita. Ou seja, toda vez que formos interpretar os coeficientes utilizaremos $1.000 como sendo equivalente a uma unidade de medida. À medida que esses modelos ficam mais complexos, mudaremos do PIB per capita regular para o PIB per capita registrado para fins de cálculo.
Podemos observar abaixo a extração da média e do desvio padrão do PIB per capita centralizado e do PIB per capita registrado centralizado, o que nos auxiliará no nosso processo:

```{r}
gdp_mean_sd <- attributes(gapminder$gdpPercap_z)
gdp_mean <- gdp_mean_sd$`scaled:center`
gdp_sd <- gdp_mean_sd$`scaled:scale`

gdp_log_mean_sd <- attributes(gapminder$gdpPercap_log_z)
gdp_log_mean <- gdp_log_mean_sd$`scaled:center`
gdp_log_sd <- gdp_log_mean_sd$`scaled:scale`
```

* -> As variáveis significam: expVida = expectativa de vida e PIB = PIB per capita.


## Item 3:
### Relação entre modelo multinível com essa diferença entre países

(gráfico das diferentes trajetórias ao longo do tempo)

```{r}

```

A partir da análise gráfica acima disponível, constata-se que cada país possui uma relação ligeiramente diferente entre riqueza e expectativa de vida. Usando a modelagem multinível, podemos incorporar compensações específicas do país tanto no intercepto ($\beta_0$) quanto no efeito PIB per capita fixo ($\beta_1$). Como sempre, cada uma dessas compensações específicas do país possuem sua própria variação, a qual chamamos de $\tau$.

$ ExpVida = (\beta_0 + b_{0,país}) + (\beta_1PIB + b_{1,país} + \beta_2ano + \ $
$ b_{0,país} ~ N(0, \tau_0)$
$ b_{1,país} ~ N(0, \tau_1) $

A sintaxe para este termo de efeitos aleatórios é:

(1 + PIB_z | país)

 considerando que estamos permitindo que o intercepto (que é igual a 1) e o PIB per capita variem por país. Usaremos as versões em escala do PIB per capita regular e do PIB per capita registrado.
 
 Utilizamos o argumento ‘QR’ para decomposição do brms para descorrelacionarmos covariáveis altamente correlacionadas (como ano e PIB em todo o país), o que acelera nosso cálculo.
 
```{r}

model_gdp_country_only <- brm(
  bf(lifeExp ~ gdpPercap_z + year + (1 + gdpPercap_z | country),
     decomp = "QR"),
  data = gapminder,
  chains = 4, seed = bayes_seed,
  threads = threading(2)  
)


model_gdp_country_only_log <- brm(
  bf(lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_log_z | country),
     decomp = "QR"),
  data = gapminder,
  chains = 4, seed = bayes_seed,
  threads = threading(2)  
)

```
 

 
## Item 4:
### Incluindo  efeitos aleatórios para diferenças específicas do ano no PIB efeito per capita, que são independentes das diferenças específicas de cada país no modelo.

Cada país obtém seu próprio intercepto e declives do PIB e do ano e compensações específicas do ano no declive do PIB
Abordar nosso modelo de modo:

(expVida ~ PIB_z + ano + ( 1 + PIB_z + ano | país ) 

por si já seria suficiente. Porém, se estivermos interessados em incluir efeitos aleatórios para diferenças específicas do ano no PIB per capita, que são independentes das diferenças específicas de cada país, devemos sofisticar nossa abordagem. Casos que podem ilustrar essa necessidade são recessões ou pandemias. Nós faremos isso de modo que cada país obtenha seu próprio intercepto e declives do PIB e do ano, e compensações específicas do ano no declive do PIB.
Para fazermos isso, adicionaremos compensações baseadas no ano independentes ao intercepto ($\beta_{0, ano}$) e ao efeito do PIB, de modo que:

$ ExpVida = (\beta_0 + b_{0, país} + b_{0, ano}) + \beta_1PIB + b_{1, país} + b_{1, ano}) + (\beta_2ano + b_{2, país}) $

$ b_{0, país} ~ N(0, \tau_{0, país})$
$ b_{1, país} ~ N(0, \tau_{1, país}) $
$ b_{2, país} ~ N(0, \tau_{2, país})$
$ b_{0, ano} ~ N(0, \tau_{0, ano}) $
$ b_{1, ano} ~ N(0, \tau_{1, ano}) $

Por fim, sofisticamos nossa abordagem de modo a obter:

 (1 + PIB_log_z | ano) + (1 + PIB_log_z + ano | país).
 
 É interessante ressaltar que estamos trabalhando apenas com o PIB per capita registrado. O intercepto e o efeito do PIB obtêm suas próprias compensações específicas do ano, e o intercepto, o efeito do PIB e o efeito do ano obtêm suas próprias compensações específicas do país.
 
```{r}
model_gdp_country_year_year <- brm(
  bf(lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_log_z | year) + 
       (1 + gdpPercap_log_z + year | country),
     decomp = "QR"),
  data = gapminder,
  cores = 4, chains = 4, seed = bayes_seed,
  threads = threading(2)
)
```
 
 
```{r}
rstan::get_elapsed_time(model_gdp_country_year_year$fit) %>% 
  as_tibble(rownames = "chain") %>% mutate(total_seconds = warmup + sample)

```

### Item 5: 
## O que são efeitos marginais médios instantâneos

  Um efeito marginal é criado ao se encaixar um acréscimo em certo comportamento. O efeito marginal médio instantâneo fornece um efeito sobre uma probabilidade, basicamente trata-se da variação média da probabilidade quando x aumenta em uma unidade.
  
  
# Resultados

## Resultados para o modelo base (item 1):

Com base no modelo inicial construído no item 1 da metodologia, temos que, quando o ano é 0 (ou em 1952) e quando o PIB per capita de um país é $ 0, a esperança média de vida é de 52,57 anos em média, ou seja, ele aumenta em 0,24 anos anualmente depois disso, mantendo a renda constante, e aumenta em 0,66 anos para cada $ 1.000 de aumento na riqueza, mantendo o tempo constante.
Se olharmos, ainda, para o PIB per capita registrado,observamos que o aumento de 10% no PIB per capita está associado a um aumento de 0,774 (7,74 / 10) anos na expectativa de vida, mantendo assim o tempo constante.


```{r}
ame_model_gdp_boring <- model_gdp_boring %>% 
  emtrends(~ 1,
           var = "gdpPercap_z",
           at = list(year = 0),
           epred = TRUE, re_formula = NULL)

pred_ame_model_gdp_boring <- ame_model_gdp_boring %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = .value / gdp_sd * 1000) %>% 
  mutate(fake_facet_title = "GDP per capita")

plot_ame_gdp <- ggplot(pred_ame_model_gdp_boring, aes(x = .value)) +
  stat_halfeye(fill = palette_okabe_ito(5),
               .width = c(0.8, 0.95)) +
  labs(x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a $1,000 increase in GDP per capita"), 
       y = "Density") +
  facet_wrap(vars(fake_facet_title)) +
  theme_clean() +
  theme(strip.text = element_text(size = rel(1.1)))


ame_model_gdp_boring_log <- model_gdp_boring_log %>% 
  emtrends(~ 1,
           var = "gdpPercap_log_z",
           at = list(year = 0),
           epred = TRUE, re_formula = NULL)

pred_ame_model_gdp_boring_log <- ame_model_gdp_boring_log %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = .value / gdp_log_sd / 10) %>% 
  mutate(fake_facet_title = "Logged GDP per capita")

plot_ame_gdp_log <- ggplot(pred_ame_model_gdp_boring_log, aes(x = .value)) +
  stat_halfeye(fill = palette_okabe_ito(5),
               .width = c(0.8, 0.95)) +
  labs(x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a 10% increase in GDP per capita"), 
       y = "Density") +
  facet_wrap(vars(fake_facet_title)) +
  theme_clean() +
  theme(strip.text = element_text(size = rel(1.1)))

(plot_ame_gdp + plot_ame_gdp_log) +
  plot_annotation(title = paste0("Average marginal effect of GDP per capita", "\n",
                                 "(includes year trend with no country-based variation)"), 
                  subtitle = "lifeExp ~ gdpPercap_log_z + year",
                  caption = "80% and 95% credible intervals shown with error bar",
                  theme = theme_clean() + theme(plot.subtitle = element_text(family = "Consolas")))
```


## Modelo com PIB variando por país:


Os coeficientes em nível de população global são semelhantes aos que vimos anteriormente no modelo básico sem efeitos de país aleatórios: mantendo constantes as tendências anuais, a expectativa de vida aumenta em 1,17 anos para cada aumento de $ 1.000 na riqueza e 0,341 anos para cada aumento de 10% na riqueza, em média. 

```{r}

tidy(model_gdp_country_only) %>% 
  mutate(across(c(estimate, std.error, conf.low, conf.high),
                ~ifelse(term %in% c("gdpPercap_z", "sd__gdpPercap_z"), 
                        (. / gdp_sd) * 1000, .)))

tidy(model_gdp_country_only_log) %>% 
  mutate(across(c(estimate, std.error, conf.low, conf.high),
                ~ifelse(term %in% c("gdpPercap_log_z", "sd__gdpPercap_log_z"), 
                        (. / gdp_log_sd), .)))

```

Também temos alguns termos de efeitos aleatórios que podemos interpretar. A variância da interceptação (sd __ (Intercept)) corresponde a ($\tau_0$) e nos mostra o quanto a expectativa de vida oscila entre os países. Também podemos ver em que proporção essa variação em nível de país contribui para a variação residual total do modelo. Para o modelo do PIB per capita, a estrutura do país contribuiu com 77% (9,98 / (9,98 + 2,92)) da variação total da expectativa de vida, enquanto contribuiu com 80% (11,19 / (11,19 + 2,76)) no PIB per capita registrado modelo.
O termo sd__PID_z é ($\tau_1$ - simbolo) e mostra a variação específica do país no efeito do PIB. Isso é menor do que a variância de interceptação, mas ocorre porque o efeito do PIB é uma inclinação que mede a mudança marginal na expectativa de vida conforme a riqueza aumenta em uma unidade ($ 1.000), não a própria expectativa de vida. (Nós removemos a escala dos valores de sd__PIB_z e sd__PIB_log_z aqui também, como fizemos com seus coeficientes fixos reais.)
Finalmente, temos um termo que mostra a correlação das interceptações e inclinações específicas do país. No modelo regular do PIB per capita, vemos uma correlação de 0,2, o que significa que os países com menores interceptos estão associados a menores efeitos do PIB - os países que começaram pobres em 1952 crescem mais devagar. Essa correlação se inverte no modelo de PIB per capita registrado, onde temos uma correlação de -0,28, o que implica que países com menores interceptos estão associados a efeitos de PIB maiores - países que começaram pobres em 1952 crescem mais rápido. Uma hipótese do porque essa reversão ocorre é que as duas medidas do PIB capturam coisas diferentes: a versão registrada mostra mudanças em ordens de magnitude, enquanto a versão regular mostra mudanças nos valores em dólares. De alguma forma, essa diferença faz a correlação virar.


Como um atributo extra, podemos observar as compensações em nível de país para o intercepto e a inclinação do PIB.

```{r}
ranef(model_gdp_country_only)$country %>%
  as_tibble(rownames = "country") %>% 
  filter(country %in% countries$country) %>% 
  select(country, starts_with("Estimate")) %>% 
  mutate(Estimate.gdpPercap_z = Estimate.gdpPercap_z / gdp_sd * 1000)

```


Também podemos olhar para o efeito fixo + deslocamento aleatório já combinado para interceptações e declives específicos do país. A interceptação e a inclinação são diferentes em cada país, enquanto o coeficiente do ano é o mesmo, como esperado:

```{r}
coef(model_gdp_country_only)$country %>%
  as_tibble(rownames = "country") %>% 
  filter(country %in% countries$country) %>% 
  select(country, starts_with("Estimate")) %>% 
  # Unscale the GDP offsets
  mutate(Estimate.gdpPercap_z = Estimate.gdpPercap_z / gdp_sd * 1000)
```

Visualizando modelo final:

Podemos ver as distribuições a posteriori completas para esses efeitos de PIB específicos de cada país para ter uma noção de sua variação. Olhar para o PIB regular mostra algumas tendências interessantes - e revela alguns problemas potenciais com o modelo. Em todos os países, exceto Canadá, Itália e Portugal, um aumento de US $ 1.000 no PIB per capita - mantendo todos os outros fatores constantes - está associado a um aumento de 2 a 5 anos na expectativa de vida. Essa diferença é “estatisticamente significativa” se quisermos usar esse tipo de linguagem frequentista - os intervalos confiáveis para todos esses efeitos estão bem longe de 0. Canadá, Itália e Portugal, entretanto, não veem nenhum efeito prático do PIB. Suas inclinações são essencialmente zero e são estimadas com precisão em torno de zero (por isso obtemos picos bem altos). Isso poderia ser um artefato do modelo - esses três países já tinham altos níveis de renda e Stan luta com extremos como esse.

```{r}
ame_model_gdp_country_only <- model_gdp_country_only %>% 
  emtrends(~ country,
           var = "gdpPercap_z",
           at = list(year = 0, country = countries$country),
           epred = TRUE, re_formula = NULL)

pred_ame_model_gdp_country_only <- ame_model_gdp_country_only %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = .value / gdp_sd * 1000) %>% 
  left_join(countries, by = "country")

ggplot(pred_ame_model_gdp_country_only, aes(x = .value)) +
  stat_halfeye(aes(fill = continent)) +
  geom_vline(xintercept = 0) +
  scale_fill_okabe_ito(order = c(2, 3, 6, 1), guide = "none") +
  labs(title = paste0("Average marginal effect of GDP per capita", "\n",
                      "(intercepts and slope of GDP per capita by country)"), 
       subtitle = "lifeExp ~ gdpPercap_z + year + (1 + gdpPercap_z | country)",
       x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a $1,000 increase in GDP per capita"), 
       y = "Density",
       caption = "80% and 95% credible intervals shown with error bar") +
  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings) +
  theme_clean() +
  theme(plot.subtitle = element_text(family = "Consolas"))
```


Em vez disso, obtemos algumas distribuições de aparência mais normal quando observamos o efeito do PIB per capita registrado. Canadá, Itália e Portugal ainda são efeitos nulos aparentes, uma vez que seus intervalos de credibilidade incluem zero, enquanto todos os outros países têm efeitos positivos. Um aumento de 10% no PIB per capita está associado a um aumento de 0,5 a 1,2 ano na expectativa de vida, em média.


```{r}
ame_model_gdp_country_only_log <- model_gdp_country_only_log %>% 
  emtrends(~ country,
           var = "gdpPercap_log_z",
           at = list(year = 0, country = countries$country),
           epred = TRUE, re_formula = NULL)
ame_model_gdp_country_only_log

pred_ame_model_gdp_country_only_log <- ame_model_gdp_country_only_log %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = .value / gdp_log_sd / 10) %>% 
  left_join(countries, by = "country")

ggplot(pred_ame_model_gdp_country_only_log, aes(x = .value)) +
  stat_halfeye(aes(fill = continent)) +
  geom_vline(xintercept = 0) +
  scale_fill_okabe_ito(order = c(2, 3, 6, 1), guide = "none") +
  labs(title = paste0("Average marginal effect of GDP per capita", "\n",
                      "(intercepts and slope of GDP per capita by country)"), 
       subtitle = "lifeExp ~ gdpPercap_z + year + (1 + gdpPercap_z | country)",
       x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a 10% increase in GDP per capita"), 
       y = "Density",
       caption = "80% and 95% credible intervals shown with error bar") +
  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings) +
  theme_clean() +
  theme(plot.subtitle = element_text(family = "Consolas"))

```

## Modelo que incorpora diferenças específicas de cada país tanto para o PIB quanto para o ano.

Os coeficientes em nível de população global são novamente semelhantes aos que vimos nos modelos anteriores: mantendo as tendências anuais constantes, a expectativa de vida aumenta em 0,45 anos para cada aumento de $ 1.000 na riqueza e 0,427 anos para cada aumento de 10% na riqueza, em média.

```{r}
# Unscale both the GDP coefficient and the GDP random variance coefficient
tidy(model_gdp_country_year) %>% 
  mutate(across(c(estimate, std.error, conf.low, conf.high),
                ~ifelse(term %in% c("gdpPercap_z", "sd__gdpPercap_z"), 
                        (. / gdp_sd) * 1000, .)))

tidy(model_gdp_country_year_log) %>% 
  mutate(across(c(estimate, std.error, conf.low, conf.high),
                ~ifelse(term %in% c("gdpPercap_log_z", "sd__gdpPercap_log_z"), 
                        (. / gdp_log_sd), .)))

```

Vamos renunciar a interpretações detalhadas de todos os nossos novos valores de efeitos aleatórios e, em vez disso, apenas apontar que temos estimativas para cada um dos: variação com base no país na interceptação, a inclinação do PIB e a inclinação do ano. Também temos três correlações diferentes agora: a correlação entre a interceptação e a curva do PIB, a interceptação e a curva do ano, e a curva do PIB e do ano. 
Se olharmos para os coeficientes em nível de país, podemos ver que as interceptações, as inclinações do PIB e as inclinações do ano variam em valores diferentes entre os países, conforme pretendido.

```{r}
coef(model_gdp_country_year)$country %>%
  as_tibble(rownames = "country") %>% 
  filter(country %in% countries$country) %>% 
  select(country, starts_with("Estimate")) %>% 
  # Unscale the GDP offsets
  mutate(Estimate.gdpPercap_z = Estimate.gdpPercap_z / gdp_sd * 1000)
```

Como de costume, podemos visualizar a distribuição desses efeitos do PIB específicos de cada país. Se olharmos para o PIB regular, podemos ver imediatamente alguma estranheza - algumas dessas distribuições como Serra Leoa e Bolívia não são muito suaves, provavelmente porque não especificamos bons antecedentes e porque o modelo não convergiu totalmente. Essas coisas parecem bobas e não devemos dar muito valor a elas. Canadá, Itália e Portugal parecem ter efeitos nulos, junto com o Egito agora por qualquer motivo. Mas, novamente, estes são estranhos e o modelo não é tão bom, então podemos parar de olhar para isso.

```{r}
ame_model_gdp_country_year <- model_gdp_country_year %>% 
  emtrends(~ year + country,
           var = "gdpPercap_z",
           at = list(year = 0, country = countries$country),
           epred = TRUE, re_formula = NULL)

pred_ame_model_gdp_country_year <- ame_model_gdp_country_year %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = .value / gdp_sd * 1000) %>% 
  left_join(countries, by = "country")

ggplot(pred_ame_model_gdp_country_year, aes(x = .value)) +
  stat_halfeye(aes(fill = continent)) +
  geom_vline(xintercept = 0) +
  scale_fill_okabe_ito(order = c(2, 3, 6, 1), guide = "none") +
  labs(title = paste0("Average marginal effect of GDP per capita", "\n",
                      "(intercepts and slopes of both GDP per capita and year vary by country)"), 
       subtitle = "lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_z + year | country)",
       x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a $1,000 increase in GDP per capita"), 
       y = "Density",
       caption = "80% and 95% credible intervals shown with error bar") +
  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings) +
  theme_clean() +
  theme(plot.subtitle = element_text(family = "Consolas"))
```


Os efeitos marginais médios para o PIB per capita registrado parecem muito mais suaves (e o modelo realmente convergiu), então eu confio mais nesses resultados. Depois de contabilizar as diferenças específicas de país e ano, Canadá, Itália e Portugal apresentam inclinações positivas do PIB per capita: um aumento de 10% no PIB per capita está associado a um aumento de 0,5hs na expectativa de vida. Vemos um efeito ligeiramente menor em Serra Leoa e efeitos ainda menores (e menos “significativos”) em todos os outros lugares.

```{r}
ame_model_gdp_country_year_log <- model_gdp_country_year_log %>% 
  emtrends(~ year + country,
           var = "gdpPercap_log_z",
           at = list(year = 0, country = countries$country),
           epred = TRUE, re_formula = NULL)

pred_ame_model_gdp_country_year_log <- ame_model_gdp_country_year_log %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = .value / gdp_log_sd / 10) %>% 
  left_join(countries, by = "country")

ggplot(pred_ame_model_gdp_country_year_log, aes(x = .value)) +
  stat_halfeye(aes(fill = continent)) +
  geom_vline(xintercept = 0) +
  scale_fill_okabe_ito(order = c(2, 3, 6, 1), guide = "none") +
  labs(title = paste0("Average marginal effect of GDP per capita", "\n",
                      "(intercepts and slopes of both GDP per capita and year vary by country)"), 
       subtitle = "lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_log_z + year | country)",
       x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a 10% increase in GDP per capita"), 
       y = "Density",
       caption = "80% and 95% credible intervals shown with error bar") +
  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings) +
  theme_clean() +
  theme(plot.subtitle = element_text(family = "Consolas"))
```

É realmente muito legal podermos olhar para o efeito específico do PIB na expectativa de vida em cada país individualmente, mas muitas vezes queremos apenas relatar um único número - qual é o efeito médio da saúde sobre a riqueza? Não queremos relatar 140 efeitos separados do PIB! Só queremos um!

Podemos consolidar esses efeitos específicos do país em um único valor de duas maneiras diferentes:

Relate uma grande média global ou o resultado médio previsto, ignorando os desvios específicos do país
Relate o resultado médio previsto para um novo país hipotético
Existem muitos detalhes sobre essas diferentes abordagens para encontrar efeitos marginais médios neste post aqui - acesse lá para aprender tudo sobre as nuances de fazer isso.

Aqui, faremos as duas coisas: calcular uma grande média global e simular um novo país falso (vamos chamá-lo de Atlântida).


```{r}

ame_global_gdp_country_year <- model_gdp_country_year_log %>% 
  emtrends(~ 1,
           var = "gdpPercap_log_z",
           epred = TRUE, re_formula = NA)
ame_global_gdp_country_year


pred_global_gdp_country_year <- ame_global_gdp_country_year %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = (.value / gdp_log_sd) / 10) %>% 
  mutate(fake_facet_title = "Global grand mean")

plot_global_gdp_country_year <- ggplot(pred_global_gdp_country_year, aes(x = .value)) +
  stat_halfeye(fill = palette_okabe_ito(5)) +
  geom_vline(xintercept = 0) +
  labs(x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a 10% increase in GDP per capita"), 
       y = "Density") +
  facet_wrap(vars(fake_facet_title)) +
  theme_clean() +
  theme(strip.text = element_text(size = rel(1.1)))


ame_hypo_gdp_country_year <- model_gdp_country_year_log %>% 
  emtrends(~ 1 + country,
           var = "gdpPercap_log_z",
           at = list(country = "Atlantis"),
           epred = TRUE, re_formula = NULL, 
           allow_new_levels = TRUE, sample_new_levels = "gaussian")
ame_hypo_gdp_country_year

pred_hypo_gdp_country_year <- ame_hypo_gdp_country_year %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = (.value / gdp_log_sd) / 10) %>% 
  mutate(fake_facet_title = "AME for hypothetical Atlantis")

plot_hypo_gdp_country_year <- ggplot(pred_hypo_gdp_country_year, aes(x = .value)) +
  stat_halfeye(fill = palette_okabe_ito(7)) +
  geom_vline(xintercept = 0) +
  labs(x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a 10% increase in GDP per capita"), 
       y = "Density") +
  facet_wrap(vars(fake_facet_title)) +
  theme_clean() +
  theme(strip.text = element_text(size = rel(1.1)))

(plot_global_gdp_country_year | plot_hypo_gdp_country_year) +
  plot_annotation(title = paste0("Average marginal effect of GDP per capita", "\n",
                                 "(intercepts and slopes of both GDP per capita and year vary by country)"), 
                  subtitle = "lifeExp ~ gdpPercap_log_z + year + (1 + gdpPercap_log_z + year | country)",
                  caption = "80% and 95% credible intervals shown with error bar",
                  theme = theme_clean() + theme(plot.subtitle = element_text(family = "Consolas")))
```



## Modelo completo (incluindo efeitos aleatórios):

Os coeficientes globais da população são novamente semelhantes aos que vimos nos modelos anteriores: mantendo constantes as tendências anuais, a expectativa de vida aumenta 0,332 anos para cada 10% de aumento na riqueza, em média.

```{r}
tidy(model_gdp_country_year_year) %>% 
  mutate(across(c(estimate, std.error, conf.low, conf.high),
                ~ifelse(term %in% c("gdpPercap_log_z", "sd__gdpPercap_log_z"), 
                        (. / gdp_log_sd), .)))

```


Observe que há cinco valores de $\tau$ diferentes, conforme o esperado, e quatro correlações diferentes.
Se olharmos para os coeficientes em nível de país, podemos ver que os interceptos, as inclinações do PIB e as inclinações do ano variam em valores diferentes entre os países:

```{r}
coef(model_gdp_country_year)$country %>%
  as_tibble(rownames = "country") %>% 
  filter(country %in% countries$country) %>% 
  select(country, starts_with("Estimate")) %>% 
  mutate(Estimate.gdpPercap_z = Estimate.gdpPercap_z / gdp_sd * 1000)

```

Ainda melhor, porém, é que a inclinação do PIB também muda a cada ano! Isso é o que ganhamos por incluir o termo 
(1 + gdpPercap_log_z | ano). 
As inclinações do PIB específicas do país mudam ao longo do tempo agora:


```{r}
model_gdp_country_year_year %>% 
  emtrends(~ year + country,
           var = "gdpPercap_log_z",
           at = list(year = c(0, 5), country = countries$country),
           epred = TRUE, re_formula = NULL)

```


Podemos ver essa mudança com base no tempo fazendo uma versão um pouco mais elaborada de nosso gráfico de efeito marginal médio específico do país. Mostraremos a distribuição posterior para cada ano dentro de cada país usando a biblioteca ridgeplots. Também vamos sombrear os intervalos confiáveis aqui usando a estética fill_ramp em vez de mostrar um ponto e uma linha, uma vez que ficaria muito visualmente ocupado de outra forma.
Em alguns países como Egito e Canadá, o efeito do PIB é razoavelmente constante ao longo do tempo. Em outros, como Serra Leoa, você pode ver o efeito do PIB encolher ligeiramente nas décadas de 1980 e 1990, e aumentar novamente depois disso.

```{r}
ame_model_gdp_country_year_year <- model_gdp_country_year_year %>% 
  emtrends(~ year + country,
           var = "gdpPercap_log_z",
           at = list(year = seq(0, 55, by = 5), country = countries$country),
           epred = TRUE, re_formula = NULL)

pred_model_gdp_country_year_year <- ame_model_gdp_country_year_year %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = (.value / gdp_log_sd) / 10) %>% 
  mutate(year = year + 1952,
         year = fct_inorder(factor(year))) %>%
  left_join(countries, by = "country")

ggplot(pred_model_gdp_country_year_year, aes(x = .value, fill = year)) +
  stat_slab(aes(y = fct_rev(year), fill = year,
                fill_ramp = stat(cut_cdf_qi(cdf, .width = c(0.02, 0.8, 0.95, 1)))),
            height = 2, color = "white", slab_size = 0.5) +
  scale_fill_viridis_d(option = "rocket", guide = "none", end = 0.9) +
  scale_fill_ramp_discrete(range = c(1, 0.2), guide = "none") +
  geom_vline(xintercept = 0) +
  labs(title = paste0("Average marginal effect of GDP per capita", "\n",
                      "(intercepts and slopes of both GDP per capita and year ",
                      "vary by country + intercepts vary by year)"), 
       subtitle = paste0("lifeExp ~ gdpPercap_log_z + year + ", 
                         "(1 + gdpPercap_log_z | year) + ", 
                         "(1 + gdpPercap_log_z + year | country)"),
       x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a 10% increase in GDP per capita"), 
       y = "Year",
       caption = "80% and 95% credible intervals shown with shading") +
  facet_nested_wrap(vars(continent, country), nrow = 2, strip = nested_settings,
                    scales = "free_x") +
  theme_clean() +
  theme(panel.grid.major.y = element_blank(),
        plot.subtitle = element_text(family = "Consolas"))
```


Finalmente, podemos calcular alguns efeitos marginais médios agregados para falar sobre o efeito geral da riqueza sobre a saúde. Vamos, primeiro, encontrar a grande média global, e, depois, calcular o efeito médio em nosso falso país em Atlantis em um falso ano de 2020. Por fim, vamos calcular o efeito médio em Atlantis ao longo do tempo.

```{r}

ame_global_gdp_country_year_year <- model_gdp_country_year_year %>% 
  emtrends(~ 1,
           var = "gdpPercap_log_z",
           epred = TRUE, re_formula = NA)

pred_global_gdp_country_year_year <- ame_global_gdp_country_year_year %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = (.value / gdp_log_sd) / 10) %>% 
  mutate(fake_facet_title = "Global grand mean")

plot_global_gdp_country_year_year <- ggplot(pred_global_gdp_country_year_year, aes(x = .value)) +
  stat_slab(aes(fill_ramp = stat(cut_cdf_qi(cdf, .width = c(0.02, 0.8, 0.95, 1)))),
            fill = palette_okabe_ito(5)) +
  scale_fill_viridis_d(option = "plasma", guide = "none", begin = 0.5) +
  scale_fill_ramp_discrete(range = c(1, 0.2), guide = "none") +
  geom_vline(xintercept = 0) +
  labs(x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a 10% increase in GDP per capita"), 
       y = "Density") +
  facet_wrap(vars(fake_facet_title)) +
  theme_clean() +
  theme(panel.grid.major.y = element_blank(),
        strip.text = element_text(size = rel(1.1)))


ame_hypo1_gdp_country_year_year <- model_gdp_country_year_year %>% 
  emtrends(~ country + year,
           var = "gdpPercap_log_z",
           at = list(year = (2020 - 1952), country = "Atlantis"),
           epred = TRUE, re_formula = NULL, 
           allow_new_levels = TRUE, sample_new_levels = "gaussian")

ame_hypo1_gdp_country_year_year %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = (.value / gdp_log_sd) / 10) %>% 
  median_hdci()

pred_hypo1_gdp_country_year_year <- ame_hypo1_gdp_country_year_year %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = (.value / gdp_log_sd) / 10) %>% 
  mutate(fake_facet_title = "AME for hypothetical Atlantis in 2020")

plot_hypo1_gdp_country_year_year <- ggplot(pred_hypo1_gdp_country_year_year, aes(x = .value)) +
  stat_slab(aes(fill_ramp = stat(cut_cdf_qi(cdf, .width = c(0.02, 0.8, 0.95, 1)))),
            fill = palette_okabe_ito(7)) +
  scale_fill_ramp_discrete(range = c(1, 0.2), guide = "none") +
  geom_vline(xintercept = 0) +
  labs(x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a 10% increase in GDP per capita"), 
       y = "Density") +
  facet_wrap(vars(fake_facet_title)) +
  theme_clean() +
  theme(panel.grid.major.y = element_blank(),
        strip.text = element_text(size = rel(1.1)))

ame_hypo_gdp_country_year_year <- model_gdp_country_year_year %>% 
  emtrends(~ country + year,
           var = "gdpPercap_log_z",
           at = list(year = seq(0, 55, by = 5), country = "Atlantis"),
           epred = TRUE, re_formula = NULL, 
           allow_new_levels = TRUE, sample_new_levels = "gaussian")

pred_hypo_gdp_country_year_year <- ame_hypo_gdp_country_year_year %>% 
  gather_emmeans_draws() %>% 
  mutate(.value = (.value / gdp_log_sd) / 10) %>% 
  mutate(year = year + 1952,
         year = fct_inorder(factor(year))) %>%
  mutate(fake_facet_title = "AME for hypothetical Atlantis across time")

plot_hypo_gdp_country_year_year <- ggplot(pred_hypo_gdp_country_year_year, aes(x = .value)) +
  stat_slab(aes(y = fct_rev(year), fill = year,
                fill_ramp = stat(cut_cdf_qi(cdf, .width = c(0.02, 0.8, 0.95, 1)))),
            height = 2, color = "white") +
  scale_fill_viridis_d(option = "rocket", guide = "none", end = 0.9) +
  scale_fill_ramp_discrete(range = c(1, 0.2), guide = "none") +
  geom_vline(xintercept = 0) +
  labs(x = paste0("Average marginal effect on life expectancy", "\n", 
                  "of a 10% increase in GDP per capita"), 
       y = "Year") +
  facet_wrap(vars(fake_facet_title)) +
  theme_clean() +
  theme(panel.grid.major.y = element_blank(),
        strip.text = element_text(size = rel(1.1)))

((plot_global_gdp_country_year_year / plot_hypo1_gdp_country_year_year) | 
    plot_hypo_gdp_country_year_year) +
  plot_annotation(title = paste0("Average marginal effect of GDP per capita", "\n",
                                 "(intercepts and slopes of both GDP per capita and year ",
                                 "vary by country + intercepts and GDP slopes vary by year)"), 
                  subtitle = paste0("lifeExp ~ gdpPercap_log_z + year + ", 
                         "(1 + gdpPercap_log_z | year) + ", 
                         "(1 + gdpPercap_log_z + year | country)"),
                  caption = "80% and 95% credible intervals shown with shading",
                  theme = theme_clean() + theme(plot.subtitle = element_text(family = "Consolas")))
```













